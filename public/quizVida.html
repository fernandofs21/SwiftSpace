<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <link rel="stylesheet" href="css/quizVida.css">
    <link rel="stylesheet" href="css/dashboards.css">
    <script src="js/sessao.js"></script>
</head>

<body onload="validarSessao()" class="quiz1">
    <div class="janela">
        <div class="header-left">
            <h1>SwiftSpace</h1>

            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="list-btns">
                <div class="btn-nav inicio">
                    <a href="dashboard.html">
                        <h3>Início</h3>
                    </a>
                </div>
    
                <div class="texto">
                    <h3>Teste seus conhecimentos sobre:</h3>
                </div>
                
                <div class="btn-nav active-page">
                    <a href="quizVida.html">
                        <h3>A Vida Pessoal de Taylor Swift</h3>
                    </a>
                </div>
    
                <div class="btn-nav">
                    <a href="quizLyrics.html">
                        <h3>As letras de Taylor Swift</h3>
                    </a>
                </div>
    
                <div class="btn-nav">
                    <a href="quizMusicas.html">
                        <h3>As Músicas e Álbuns de Taylor Swift</h3>
                    </a>
                </div>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>

        <div class="box">
            <a href="dashboard.html">
            <div class="sair"><img src="assets/icons/voltar.png" class="imgsair"> Voltar</div>
        </a>

        <div class="quiz">
            <div class="ranking"></div>
            <div class="game iniciar" id="iniciar">
                <div class="titulo">Quiz de conhecimentos sobre a vida pessoal Taylor Swift</div>
                <button onclick="mostrarPergunta()" id="botao_iniciar">JOGAR</button>
                <div class="pontuacao" id="div_pontos"></div>
            </div>
            <div class="game" id="perguntas">
                <div class="number"><span id="numero_pergunta"></span>
                    <div id="dificuldade_pergunta"></div>
                </div>
                <div class="question" id="div_pergunta"></div>
                <div class="alternatives">
                    <div class="botao" id="alt1" onclick="verificar(0)"></div>
                    <div class="botao" id="alt2" onclick="verificar(1)"></div>
                    <div class="botao" id="alt3" onclick="verificar(2)"></div>
                    <div class="botao" id="alt4" onclick="verificar(3)"></div>
                </div>
            </div>
            <div class="graph"></div>
        </div>
    </div>
</body>

</html>
<script>
    var perguntas_quiz = [
        {
            pergunta: "Qual é a data de nascimento de Taylor Swift?",
            alternativas: ["13 de Dezembro de 1989", "31 de Dezembro de 1989", "13 de Novembro de 1989", "31 de Novembro de 1989"],
            resposta: 0,
            dificuldade: "Fácil"
        },
        {
            pergunta: "Pra qual cidade Taylor e sua família se mudaram quando ela tinha 14 anos?",
            alternativas: ["Pensilvânia", "Nova Iorque", "Nashville", "Los Angeles"],
            resposta: 2,
            dificuldade: "Difícil"
        },
        {
            pergunta: "Quantos gatos Taylor tem?",
            alternativas: ["1", "2", "3", "4"],
            resposta: 2,
            dificuldade: "Média"
        },
        {
            pergunta: ""
        }
    ];

    var pergunta_atual = 0;
    var pontos = 0;
    var idUsuario = sessionStorage.ID_USUARIO;
    var idQuiz = 1;
    var idTentativa = 0;

    function contarTentativas() {
        fetch(`/quiz/contarTentativas/${idUsuario}/${idQuiz}`) 
        .then(resposta => resposta.json())
            .then(data => {
                console.log(data)
               idTentativa = data.tentativas;
            })
            .catch(error => {
                console.error('Erro ao verificar tentativas:', error);
            });
        console.log(idTentativa);
    }

    function embaralhar() {
        for (var index = perguntas_quiz.length - 1; index > 0; index--) {
            var novoIndex = Math.floor(Math.random() * (index + 1));
            [perguntas_quiz[index], perguntas_quiz[novoIndex]] = [perguntas_quiz[novoIndex], perguntas_quiz[index]];
        }
    }

    function mostrarPergunta() {

        iniciar.style.display = "none";
        perguntas.style.display = "flex";


        numero_pergunta.innerHTML = `${pergunta_atual + 1}.`
        dificuldade_pergunta.innerHTML = `Dificuldade: ${perguntas_quiz[pergunta_atual].dificuldade}`
        div_pergunta.innerHTML = `${perguntas_quiz[pergunta_atual].pergunta}`;
        alt1.innerHTML = `${perguntas_quiz[pergunta_atual].alternativas[0]}`;
        alt2.innerHTML = `${perguntas_quiz[pergunta_atual].alternativas[1]}`;
        alt3.innerHTML = `${perguntas_quiz[pergunta_atual].alternativas[2]}`;
        alt4.innerHTML = `${perguntas_quiz[pergunta_atual].alternativas[3]}`;
    }

    function verificar(selected) {
        var correta = perguntas_quiz[pergunta_atual].resposta;
        var selectedElement = document.getElementById(`alt${selected + 1}`);
        var corretaElement = document.getElementById(`alt${correta + 1}`);

        if (selected === correta) {
            selectedElement.classList.add('correto');
            pontos++;
        } else {
            selectedElement.classList.add('errado');
            corretaElement.classList.add('correto');
        }

        setTimeout(() => {
            pergunta_atual++;

            if (pergunta_atual < perguntas_quiz.length) {
                selectedElement.classList.remove('correto');
                selectedElement.classList.remove('errado');
                corretaElement.classList.remove('correto');
                mostrarPergunta();
            } else {
                selectedElement.classList.remove('correto');
                selectedElement.classList.remove('errado');
                corretaElement.classList.remove('correto');
                finalizarQuiz();
            }
        }, 500);
    }

    function finalizarQuiz() {
        contarTentativas();


        var resultadosQuiz = {
            idTentativa: idTentativa,
            idUsuario: idUsuario,
            idQuiz: idQuiz,
            pontos: pontos,
        };

        enviarResultados(resultadosQuiz);

        iniciar.style.display = "flex";
        perguntas.style.display = "none";

        if (pontos > (perguntas_quiz.length / 2)) {
            div_pontos.innerHTML = `PARABÉNS! VOCÊ ACERTOU ${pontos} de ${perguntas_quiz.length}`;
        } else {
            div_pontos.innerHTML = `VOCÊ ACERTOU APENAS ${pontos} de ${perguntas_quiz.length}, TENTE NOVAMENTE!`;
        }

        pergunta_atual = 0;
        pontos = 0;
        embaralhar();
    }

    function enviarResultados(resultadosQuiz) {
        console.log('Enviando dados do quiz:', resultadosQuiz); 

        console.log(resultadosQuiz)

        fetch('/quiz/registrarTentativa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(resultadosQuiz)
        })
            .then(resposta => {
                if (!resposta.ok) {
                    return resposta.text().then(textoErro => {
                        throw new Error(`Erro ao enviar dados do quiz para o servidor: ${textoErro}`);
                    });
                }
                console.log('Dados do quiz enviados com sucesso');
            })
            .catch(error => {
                console.error('Erro ao enviar dados do quiz para o servidor:', error);
            });
    }

    embaralhar();
</script>